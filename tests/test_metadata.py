import asyncio
import pytest

 
@pytest.fixture
async def async_portal_api():
    from igvf_async_client import AsyncIgvfApi
    return AsyncIgvfApi()


@pytest.fixture
def context(async_portal_api):
    from metadata import MetadataProps
    from cache import PortalCache
    from cache import PortalCacheProps
    return {
        'SOME-DUL': {
            'metadata_props': MetadataProps(
                dul='SOME-DUL',
                initial_files_query=(
                    'https://api.data.igvf.org/search/'
                    '?type=File'
                    '&file_set.data_use_limitation_summaries=HMB-MDS'
                    '&file_set.controlled_access=true'
                    '&status=released'
                    '&frame=object'
                    '&limit=all'
                ),
                portal_cache=PortalCache(
                    props=PortalCacheProps(
                        url='https://api.data.igvf.org',
                        async_portal_api=async_portal_api,
                    )
                )
            ),
            'name': 'igvf-anvil-some-dul',
            'project_id': 'PROJECT-123',
            'manifest_bucket': 'some-manifest-bucket',
            'destination_bucket': 'some-destination-bucket',
            'sleep_time_seconds': 120,
            'workspace_namespace': 'some_workspace_namespace',
            'workspace_name': 'some_workspace_name',
            'overwrite_tsvs': False,
        }
    }


@pytest.mark.asyncio(scope='session')
def test_metadata_collect_metadata(context):
    from metadata import collect_metadata
    metadata_props = context['SOME-DUL']['metadata_props']
    metadata = collect_metadata(metadata_props)
    actual = metadata['seen']
    expected = {
        "files": [
            "/configuration-files/IGVFFI6594MPVX/",
            "/configuration-files/IGVFFI7971ZCIE/",
            "/matrix-files/IGVFFI8142SBEI/",
            "/sequence-files/IGVFFI1517VBJH/",
            "/sequence-files/IGVFFI1915BHZZ/",
            "/sequence-files/IGVFFI2440LTBO/",
            "/sequence-files/IGVFFI8905WBYU/",
            "/sequence-files/IGVFFI9831SEGU/",
            "/sequence-files/IGVFFI9846ECMS/",
            "/tabular-files/IGVFFI9764GKVR/"
        ],
        "file_sets": [
            "/analysis-sets/IGVFDS0718WXPI/",
            "/measurement-sets/IGVFDS2259DWKL/",
            "/measurement-sets/IGVFDS2534CJYA/"
        ],
        "samples": [
            "/in-vitro-systems/IGVFSM7625PGWV/"
        ],
        "donors": [
            "/human-donors/IGVFDO1048RJRX/",
            "/human-donors/IGVFDO3401QPKA/",
            "/human-donors/IGVFDO5812FFJI/",
            "/human-donors/IGVFDO7463WRZR/",
            "/human-donors/IGVFDO8630TWDU/",
            "/human-donors/IGVFDO9637UZMV/"
        ]
    }
    assert actual == expected


METADATA = {'seen': {'files': ['/configuration-files/IGVFFI6594MPVX/', '/configuration-files/IGVFFI7971ZCIE/', '/matrix-files/IGVFFI8142SBEI/', '/sequence-files/IGVFFI1517VBJH/', '/sequence-files/IGVFFI1915BHZZ/', '/sequence-files/IGVFFI2440LTBO/', '/sequence-files/IGVFFI8905WBYU/', '/sequence-files/IGVFFI9831SEGU/', '/sequence-files/IGVFFI9846ECMS/', '/tabular-files/IGVFFI9764GKVR/'], 'file_sets': ['/analysis-sets/IGVFDS0718WXPI/', '/measurement-sets/IGVFDS2259DWKL/', '/measurement-sets/IGVFDS2534CJYA/'], 'samples': ['/in-vitro-systems/IGVFSM7625PGWV/'], 'donors': ['/human-donors/IGVFDO1048RJRX/', '/human-donors/IGVFDO3401QPKA/', '/human-donors/IGVFDO5812FFJI/', '/human-donors/IGVFDO7463WRZR/', '/human-donors/IGVFDO8630TWDU/', '/human-donors/IGVFDO9637UZMV/']}, 'local': {'files': {'/matrix-files/IGVFFI8142SBEI/': {'@id': '/matrix-files/IGVFFI8142SBEI/', '@type': ['MatrixFile', 'File', 'Item'], 'accession': 'IGVFFI8142SBEI', 'aliases': ['buenrostro-bernstein:surya-human-organoid-rna-matrix'], 'analysis_step_version': '/analysis-step-versions/45d73e29-280a-4faf-9762-c1b4c655b689/', 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v17', 'content_summary': 'cell by gene in sparse gene count matrix', 'content_type': 'sparse gene count matrix', 'creation_timestamp': '2025-03-06T16:51:56.240180+00:00', 'derived_from': ['/sequence-files/IGVFFI9831SEGU/', '/sequence-files/IGVFFI8905WBYU/'], 'derived_manually': False, 'file_format': 'h5ad', 'file_format_specifications': ['/documents/cae4f4ad-b937-4694-b5b7-028917c8dbab/'], 'file_set': '/analysis-sets/IGVFDS0718WXPI/', 'file_size': 63881699, 'filtered': False, 'gene_list_for': [], 'href': '/matrix-files/IGVFFI8142SBEI/@@download/IGVFFI8142SBEI.h5ad', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'md5sum': '6672db7b863aa8283fc35420d591eef5', 'principal_dimension': 'cell', 'quality_metrics': [], 'reference_files': ['/reference-files/IGVFFI0653VCGH/', '/reference-files/IGVFFI7217ZMJZ/'], 'release_timestamp': '2025-03-26T19:25:47.986726+00:00', 's3_uri': 's3://igvf-files/2025/03/06/3a7b359e-39f7-4240-a6ee-703e6299455b/IGVFFI8142SBEI.h5ad', 'schema_version': '9', 'secondary_dimensions': ['gene'], 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/processed-data/human_organoids.RNA.raw_counts.h5', 'summary': 'unfiltered cell by gene in sparse gene count matrix', 'upload_status': 'validated', 'uuid': '3a7b359e-39f7-4240-a6ee-703e6299455b', 'workflow': '/workflows/IGVFWF0507XZOR/'}, '/tabular-files/IGVFFI9764GKVR/': {'@id': '/tabular-files/IGVFFI9764GKVR/', '@type': ['TabularFile', 'File', 'Item'], 'accession': 'IGVFFI9764GKVR', 'aliases': ['buenrostro-bernstein:surya-human-organoid-atac-frag'], 'analysis_step_version': '/analysis-step-versions/e27a16d2-c700-405f-92c4-89efe1a558ce/', 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'barcode_map_for': [], 'checkfiles_version': 'v17', 'content_md5sum': '36a71d428ae6fbe8ec35a8bc9133408b', 'content_type': 'fragments', 'controlled_access': False, 'creation_timestamp': '2025-03-06T16:56:56.030217+00:00', 'derived_from': ['/sequence-files/IGVFFI9846ECMS/', '/sequence-files/IGVFFI1915BHZZ/'], 'derived_manually': False, 'file_format': 'tsv', 'file_format_specifications': ['/documents/df51876b-1c01-40e6-b68c-8b2342bbd8b6/'], 'file_set': '/analysis-sets/IGVFDS0718WXPI/', 'file_size': 1206512769, 'gene_list_for': [], 'href': '/tabular-files/IGVFFI9764GKVR/@@download/IGVFFI9764GKVR.tsv.gz', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'md5sum': '17dcfe73b68c88c636982c553da9b3ea', 'primer_design_for': [], 'quality_metrics': [], 'release_timestamp': '2025-03-26T19:25:47.961336+00:00', 's3_uri': 's3://igvf-files/2025/03/06/cc1d12c6-4a61-401c-bbb8-21314b1d6cd0/IGVFFI9764GKVR.tsv.gz', 'schema_version': '16', 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/processed-data/human_organoids.fragments.tsv.gz', 'summary': 'fragments', 'upload_status': 'validated', 'uuid': 'cc1d12c6-4a61-401c-bbb8-21314b1d6cd0', 'workflow': '/workflows/IGVFWF0507XZOR/'}, '/configuration-files/IGVFFI7971ZCIE/': {'@id': '/configuration-files/IGVFFI7971ZCIE/', '@type': ['ConfigurationFile', 'File', 'Item'], 'accession': 'IGVFFI7971ZCIE', 'aliases': ['buenrostro-bernstein:IGVFFI9846ECMS_seqspec'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v20', 'content_md5sum': 'd20d660c3769a21b1a5bc25734a80786', 'content_type': 'seqspec', 'creation_timestamp': '2025-03-18T17:53:39.686857+00:00', 'derived_manually': False, 'file_format': 'yaml', 'file_set': '/measurement-sets/IGVFDS2259DWKL/', 'file_size': 1216, 'gene_list_for': [], 'href': '/configuration-files/IGVFFI7971ZCIE/@@download/IGVFFI7971ZCIE.yaml.gz', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'md5sum': '62545fbf3d2c85d50cad140bb8c87e2e', 'quality_metrics': [], 'release_timestamp': '2025-03-26T17:33:44.362363+00:00', 's3_uri': 's3://igvf-files/2025/03/18/9ca8a328-ee28-4b84-a299-12a91a14e0d2/IGVFFI7971ZCIE.yaml.gz', 'schema_version': '8', 'seqspec_of': ['/sequence-files/IGVFFI9846ECMS/', '/sequence-files/IGVFFI1915BHZZ/', '/sequence-files/IGVFFI1517VBJH/'], 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/seqspecs/IGVFFI9846ECMS_seqspec.yaml.gz', 'summary': 'seqspec of IGVFFI9846ECMS, IGVFFI1915BHZZ, IGVFFI1517VBJH', 'upload_status': 'validated', 'uuid': '9ca8a328-ee28-4b84-a299-12a91a14e0d2', 'validate_onlist_files': True}, '/configuration-files/IGVFFI6594MPVX/': {'@id': '/configuration-files/IGVFFI6594MPVX/', '@type': ['ConfigurationFile', 'File', 'Item'], 'accession': 'IGVFFI6594MPVX', 'aliases': ['buenrostro-bernstein:IGVFFI9831SEGU_seqspec'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v20', 'content_md5sum': '2d9d479a640d48a727e859ec3ff96999', 'content_type': 'seqspec', 'creation_timestamp': '2025-03-18T17:54:10.753228+00:00', 'derived_manually': False, 'file_format': 'yaml', 'file_set': '/measurement-sets/IGVFDS2534CJYA/', 'file_size': 1242, 'gene_list_for': [], 'href': '/configuration-files/IGVFFI6594MPVX/@@download/IGVFFI6594MPVX.yaml.gz', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'md5sum': '8336c45ce32429d0f31dd3b9413c0de4', 'quality_metrics': [], 'release_timestamp': '2025-03-26T17:33:43.363708+00:00', 's3_uri': 's3://igvf-files/2025/03/18/775b9e95-6c30-4f1f-b772-428745bb0c53/IGVFFI6594MPVX.yaml.gz', 'schema_version': '8', 'seqspec_of': ['/sequence-files/IGVFFI9831SEGU/', '/sequence-files/IGVFFI8905WBYU/', '/sequence-files/IGVFFI2440LTBO/'], 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/seqspecs/IGVFFI9831SEGU_seqspec.yaml.gz', 'summary': 'seqspec of IGVFFI9831SEGU, IGVFFI8905WBYU, IGVFFI2440LTBO', 'upload_status': 'validated', 'uuid': '775b9e95-6c30-4f1f-b772-428745bb0c53', 'validate_onlist_files': True}, '/sequence-files/IGVFFI2440LTBO/': {'@id': '/sequence-files/IGVFFI2440LTBO/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI2440LTBO', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-RNA.barcode.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v19', 'content_md5sum': 'b4dd1cfff1a41329acacd41ba5c889e5', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-03-14T15:49:13.728785+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2534CJYA/', 'file_size': 6719075164, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI2440LTBO/@@download/IGVFFI2440LTBO.fastq.gz', 'illumina_read_type': 'I1', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 32, 'md5sum': 'ad6d9107e67228b2037da34dbacd634a', 'mean_read_length': 32.0, 'minimum_read_length': 32, 'quality_metrics': [], 'read_count': 301798851, 'read_names': ['Barcode index'], 'release_timestamp': '2025-03-26T17:33:43.394950+00:00', 's3_uri': 's3://igvf-restricted-files/2025/03/14/bda1245f-0708-46dc-83b0-519913e90e47/IGVFFI2440LTBO.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI6594MPVX/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/barcode-file/HuIBD01-1-orgs-more-RNA.barcode.fastq.gz', 'summary': 'I1 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': 'bda1245f-0708-46dc-83b0-519913e90e47'}, '/sequence-files/IGVFFI9831SEGU/': {'@id': '/sequence-files/IGVFFI9831SEGU/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI9831SEGU', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-RNA.R1.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v17', 'content_md5sum': '080cc154a9eb0f210442b35832d3f1ae', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-02-20T20:47:10.309046+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2534CJYA/', 'file_size': 10787849140, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI9831SEGU/@@download/IGVFFI9831SEGU.fastq.gz', 'illumina_read_type': 'R1', 'input_file_for': ['/matrix-files/IGVFFI8142SBEI/'], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 50, 'md5sum': '480e0e47270cdf96cb856fa0d8643762', 'mean_read_length': 50.0, 'minimum_read_length': 50, 'quality_metrics': [], 'read_count': 301798851, 'read_names': ['Read 1'], 'release_timestamp': '2025-03-26T17:33:43.332413+00:00', 's3_uri': 's3://igvf-restricted-files/2025/02/20/ac23fc63-362d-4539-8477-486980ffec9e/IGVFFI9831SEGU.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI6594MPVX/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/HuIBD01-1-orgs-more-RNA.R1.fastq.gz', 'summary': 'R1 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': 'ac23fc63-362d-4539-8477-486980ffec9e'}, '/sequence-files/IGVFFI8905WBYU/': {'@id': '/sequence-files/IGVFFI8905WBYU/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI8905WBYU', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-RNA.R2.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v17', 'content_md5sum': '9d38759d68910afbb9f0084f4d6fcbd7', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-02-20T20:47:14.838444+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2534CJYA/', 'file_size': 10730781494, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI8905WBYU/@@download/IGVFFI8905WBYU.fastq.gz', 'illumina_read_type': 'R2', 'input_file_for': ['/matrix-files/IGVFFI8142SBEI/'], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 50, 'md5sum': 'e1969d8435c7e1b059ab3e5df6944032', 'mean_read_length': 50.0, 'minimum_read_length': 50, 'quality_metrics': [], 'read_count': 301798851, 'read_names': ['Read 2'], 'release_timestamp': '2025-03-26T17:33:43.428408+00:00', 's3_uri': 's3://igvf-restricted-files/2025/02/20/dff839b9-e8c3-4fd5-adc8-eabf2873b34c/IGVFFI8905WBYU.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI6594MPVX/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/HuIBD01-1-orgs-more-RNA.R2.fastq.gz', 'summary': 'R2 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': 'dff839b9-e8c3-4fd5-adc8-eabf2873b34c'}, '/sequence-files/IGVFFI9846ECMS/': {'@id': '/sequence-files/IGVFFI9846ECMS/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI9846ECMS', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-ATAC.R1.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v17', 'content_md5sum': '968b773bc5729e09de1adcc9651293bc', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-02-20T20:47:07.906352+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2259DWKL/', 'file_size': 9872707806, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI9846ECMS/@@download/IGVFFI9846ECMS.fastq.gz', 'illumina_read_type': 'R1', 'input_file_for': ['/tabular-files/IGVFFI9764GKVR/'], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 50, 'md5sum': '20791df01e1ea5aaa15ac135aa01eb9e', 'mean_read_length': 49.06, 'minimum_read_length': 20, 'quality_metrics': [], 'read_count': 299990437, 'read_names': ['Read 1'], 'release_timestamp': '2025-03-26T17:33:44.260626+00:00', 's3_uri': 's3://igvf-restricted-files/2025/02/20/084c1c10-cf73-446f-940d-62c05a611b8b/IGVFFI9846ECMS.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI7971ZCIE/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/HuIBD01-1-orgs-more-ATAC.R1.fastq.gz', 'summary': 'R1 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': '084c1c10-cf73-446f-940d-62c05a611b8b'}, '/sequence-files/IGVFFI1915BHZZ/': {'@id': '/sequence-files/IGVFFI1915BHZZ/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI1915BHZZ', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-ATAC.R2.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v17', 'content_md5sum': '4c6662cd568a31198c605f03a1a01499', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-02-20T20:47:12.362489+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2259DWKL/', 'file_size': 10279868253, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI1915BHZZ/@@download/IGVFFI1915BHZZ.fastq.gz', 'illumina_read_type': 'R2', 'input_file_for': ['/tabular-files/IGVFFI9764GKVR/'], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 50, 'md5sum': 'f4981ce2ce23080f52427a1aaad3c145', 'mean_read_length': 49.06, 'minimum_read_length': 20, 'quality_metrics': [], 'read_count': 299990437, 'read_names': ['Read 2'], 'release_timestamp': '2025-03-26T17:33:44.236693+00:00', 's3_uri': 's3://igvf-restricted-files/2025/02/20/603c456d-23ca-4e4c-9db9-b01a33929f3a/IGVFFI1915BHZZ.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI7971ZCIE/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/HuIBD01-1-orgs-more-ATAC.R2.fastq.gz', 'summary': 'R2 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': '603c456d-23ca-4e4c-9db9-b01a33929f3a'}, '/sequence-files/IGVFFI1517VBJH/': {'@id': '/sequence-files/IGVFFI1517VBJH/', '@type': ['SequenceFile', 'File', 'Item'], 'accession': 'IGVFFI1517VBJH', 'aliases': ['buenrostro-bernstein:surya-HuIBD01-1-orgs-more-ATAC.barcode.fastq.gz'], 'assay_titles': ['SHARE-seq'], 'award': '/awards/HG011986/', 'checkfiles_version': 'v19', 'content_md5sum': '08a579fe281616809b1676f7179da7fa', 'content_type': 'reads', 'controlled_access': True, 'creation_timestamp': '2025-03-14T15:49:11.262501+00:00', 'derived_manually': False, 'externally_hosted': False, 'file_format': 'fastq', 'file_set': '/measurement-sets/IGVFDS2259DWKL/', 'file_size': 5206068496, 'gene_list_for': [], 'href': '/sequence-files/IGVFFI1517VBJH/@@download/IGVFFI1517VBJH.fastq.gz', 'illumina_read_type': 'I1', 'input_file_for': [], 'integrated_in': [], 'lab': '/labs/jason-buenrostro/', 'loci_list_for': [], 'maximum_read_length': 32, 'md5sum': '46da9565e75c16a169d881d83901e756', 'mean_read_length': 32.0, 'minimum_read_length': 32, 'quality_metrics': [], 'read_count': 299990437, 'read_names': ['Barcode index'], 'release_timestamp': '2025-03-26T17:33:44.212305+00:00', 's3_uri': 's3://igvf-restricted-files/2025/03/14/94b93923-9a1d-441a-af9c-3cc4fec3f153/IGVFFI1517VBJH.fastq.gz', 'schema_version': '16', 'seqspecs': ['/configuration-files/IGVFFI7971ZCIE/'], 'sequencing_kit': 'NovaSeq 6000 S4 Reagent Kit v1.5', 'sequencing_platform': '/platform-terms/EFO_0008637/', 'sequencing_run': 1, 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'submitted_file_name': 'gs://sw-igvf-submission/surya-mouse-colitis/submit-fqs/barcode-file/HuIBD01-1-orgs-more-ATAC.barcode.fastq.gz', 'summary': 'I1 reads from sequencing run 1', 'upload_status': 'validated', 'uuid': '94b93923-9a1d-441a-af9c-3cc4fec3f153'}}, 'file_sets': {'/analysis-sets/IGVFDS0718WXPI/': {'lab': '/labs/jason-buenrostro/', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-human-invitro-analysis-set'], 'accession': 'IGVFDS0718WXPI', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'file_set_type': 'intermediate analysis', 'schema_version': '10', 'input_file_sets': ['/measurement-sets/IGVFDS2259DWKL/', '/measurement-sets/IGVFDS2534CJYA/'], 'release_timestamp': '2025-03-26T19:25:47.917944+00:00', 'creation_timestamp': '2025-03-06T16:47:52.680990+00:00', '@id': '/analysis-sets/IGVFDS0718WXPI/', '@type': ['AnalysisSet', 'FileSet', 'Item'], 'uuid': 'c5b76620-4de0-4592-84a6-84bc0b4e0d31', 'summary': 'single-cell ATAC-seq (SHARE-seq), single-cell RNA sequencing assay (SHARE-seq)', 'files': ['/matrix-files/IGVFFI8142SBEI/', '/tabular-files/IGVFFI9764GKVR/'], 'control_for': [], 'submitted_files_timestamp': '2025-03-06T16:51:56.240180+00:00', 'input_for': [], 'data_use_limitation_summaries': ['HMB-MDS'], 'controlled_access': True, 'assay_titles': ['SHARE-seq'], 'samples': ['/in-vitro-systems/IGVFSM7625PGWV/'], 'donors': ['/human-donors/IGVFDO9637UZMV/', '/human-donors/IGVFDO5812FFJI/', '/human-donors/IGVFDO8630TWDU/', '/human-donors/IGVFDO3401QPKA/', '/human-donors/IGVFDO7463WRZR/', '/human-donors/IGVFDO1048RJRX/'], 'protocols': ['https://www.protocols.io/view/share-seq-v1-6qpvrdexpgmk/v1'], 'sample_summary': 'Homo sapiens colon epithelial cell organoid induced to colon, at 7 day(s) post change', 'functional_assay_mechanisms': [], 'workflows': ['/workflows/IGVFWF0507XZOR/']}, '/measurement-sets/IGVFDS2534CJYA/': {'lab': '/labs/jason-buenrostro/', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-human-organoids_mm-set39'], 'samples': ['/in-vitro-systems/IGVFSM7625PGWV/'], 'accession': 'IGVFDS2534CJYA', 'protocols': ['https://www.protocols.io/view/share-seq-v1-6qpvrdexpgmk/v1'], 'assay_term': '/assay-terms/OBI_0002631/', 'description': 'Human intestinal organoids derived from IBD patients and healthy controls', 'onlist_files': ['/tabular-files/IGVFFI4393VVCW/', '/tabular-files/IGVFFI9683HRGJ/'], 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'file_set_type': 'experimental data', 'multiome_size': 2, 'onlist_method': 'product', 'schema_version': '31', 'release_timestamp': '2025-03-26T17:33:42.996564+00:00', 'creation_timestamp': '2025-02-20T20:45:55.393727+00:00', 'preferred_assay_title': 'SHARE-seq', '@id': '/measurement-sets/IGVFDS2534CJYA/', '@type': ['MeasurementSet', 'FileSet', 'Item'], 'uuid': '5cde05d5-00b2-4b17-880a-f6ba6de99e22', 'summary': 'single-cell RNA sequencing assay (SHARE-seq)', 'files': ['/configuration-files/IGVFFI6594MPVX/', '/sequence-files/IGVFFI9831SEGU/', '/sequence-files/IGVFFI8905WBYU/', '/sequence-files/IGVFFI2440LTBO/'], 'control_for': [], 'submitted_files_timestamp': '2025-02-20T20:47:10.309046+00:00', 'input_for': ['/analysis-sets/IGVFDS0718WXPI/'], 'data_use_limitation_summaries': ['HMB-MDS'], 'controlled_access': True, 'related_multiome_datasets': ['/measurement-sets/IGVFDS2259DWKL/'], 'donors': ['/human-donors/IGVFDO9637UZMV/', '/human-donors/IGVFDO5812FFJI/', '/human-donors/IGVFDO8630TWDU/', '/human-donors/IGVFDO3401QPKA/', '/human-donors/IGVFDO7463WRZR/', '/human-donors/IGVFDO1048RJRX/'], 'externally_hosted': False}, '/measurement-sets/IGVFDS2259DWKL/': {'lab': '/labs/jason-buenrostro/', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-human-organoids_mm-set38'], 'samples': ['/in-vitro-systems/IGVFSM7625PGWV/'], 'accession': 'IGVFDS2259DWKL', 'protocols': ['https://www.protocols.io/view/share-seq-v1-6qpvrdexpgmk/v1'], 'assay_term': '/assay-terms/OBI_0002764/', 'description': 'Human intestinal organoids derived from IBD patients and healthy controls', 'onlist_files': ['/tabular-files/IGVFFI4393VVCW/', '/tabular-files/IGVFFI9683HRGJ/'], 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'file_set_type': 'experimental data', 'multiome_size': 2, 'onlist_method': 'product', 'schema_version': '31', 'release_timestamp': '2025-03-26T17:33:44.176703+00:00', 'creation_timestamp': '2025-02-20T20:45:54.148989+00:00', 'preferred_assay_title': 'SHARE-seq', '@id': '/measurement-sets/IGVFDS2259DWKL/', '@type': ['MeasurementSet', 'FileSet', 'Item'], 'uuid': '40d83370-eb74-480f-94b0-5a6f0e127d48', 'summary': 'single-cell ATAC-seq (SHARE-seq)', 'files': ['/configuration-files/IGVFFI7971ZCIE/', '/sequence-files/IGVFFI9846ECMS/', '/sequence-files/IGVFFI1915BHZZ/', '/sequence-files/IGVFFI1517VBJH/'], 'control_for': [], 'submitted_files_timestamp': '2025-02-20T20:47:07.906352+00:00', 'input_for': ['/analysis-sets/IGVFDS0718WXPI/'], 'data_use_limitation_summaries': ['HMB-MDS'], 'controlled_access': True, 'related_multiome_datasets': ['/measurement-sets/IGVFDS2534CJYA/'], 'donors': ['/human-donors/IGVFDO1048RJRX/', '/human-donors/IGVFDO5812FFJI/', '/human-donors/IGVFDO9637UZMV/', '/human-donors/IGVFDO8630TWDU/', '/human-donors/IGVFDO3401QPKA/', '/human-donors/IGVFDO7463WRZR/'], 'externally_hosted': False}}, 'samples': {'/in-vitro-systems/IGVFSM7625PGWV/': {'@id': '/in-vitro-systems/IGVFSM7625PGWV/', '@type': ['InVitroSystem', 'Biosample', 'Sample', 'Item'], 'accession': 'IGVFSM7625PGWV', 'age': 'unknown', 'aliases': ['buenrostro-bernstein:surya-H443 1_to_16, H456 17_to_32, H462 33_to_48, H511 49_to_56, H371 57_to_72, H514 73_to_88, H492A 89_to_96'], 'audit': {'INTERNAL_ACTION': [{'path': '/in-vitro-systems/IGVFSM7625PGWV/', 'level_name': 'INTERNAL_ACTION', 'level': 30, 'name': 'audit_sample_missing_publication', 'detail': 'In vitro system [IGVFSM7625PGWV](/in-vitro-systems/IGVFSM7625PGWV/) has no `publications`. Released and archived samples are expected to be associated with a publication.', 'category': 'missing publication'}]}, 'award': '/awards/HG011986/', 'cell_fate_change_protocol': '/documents/b1307ee6-f02f-42ef-a523-b0c0903618f0/', 'classifications': ['organoid'], 'creation_timestamp': '2025-02-20T20:45:24.570117+00:00', 'demultiplexed_to': [], 'donors': ['/human-donors/IGVFDO1048RJRX/', '/human-donors/IGVFDO3401QPKA/', '/human-donors/IGVFDO7463WRZR/', '/human-donors/IGVFDO8630TWDU/', '/human-donors/IGVFDO5812FFJI/', '/human-donors/IGVFDO9637UZMV/'], 'embryonic': False, 'file_sets': ['/measurement-sets/IGVFDS2534CJYA/', '/measurement-sets/IGVFDS2259DWKL/', '/analysis-sets/IGVFDS0718WXPI/'], 'institutional_certificates': ['/institutional-certificates/49b4e1cd-3aa4-454f-b58f-34a0d79fefee/', '/institutional-certificates/c3a24445-2283-427d-a290-65a31b86ffd0/'], 'lab': '/labs/jason-buenrostro/', 'multiplexed_in': [], 'origin_of': [], 'parts': [], 'pooled_in': [], 'release_timestamp': '2025-03-26T17:33:43.038534+00:00', 'sample_terms': ['/sample-terms/CL_0011108/'], 'schema_version': '28', 'sex': 'unspecified', 'sorted_fractions': [], 'sources': ['/sources/jason-buenrostro/'], 'status': 'released', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'summary': 'Homo sapiens colon epithelial cell organoid induced to colon for 7 days', 'targeted_sample_term': '/sample-terms/UBERON_0001155/', 'taxa': 'Homo sapiens', 'time_post_change': 7, 'time_post_change_units': 'day', 'uuid': 'b97ff2bf-237d-487b-8bf8-c6ecb642ef7f', 'virtual': False}}, 'donors': {'/human-donors/IGVFDO9637UZMV/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H492A 89_to_96'], 'virtual': False, 'accession': 'IGVFDO9637UZMV', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.183458+00:00', 'creation_timestamp': '2025-02-20T20:43:45.911189+00:00', '@id': '/human-donors/IGVFDO9637UZMV/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': '3a4c1041-3245-4a7a-89a3-9456a82cfda1', 'summary': '3a4c1041-3245-4a7a-89a3-9456a82cfda1'}, '/human-donors/IGVFDO5812FFJI/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H514 73_to_88'], 'virtual': False, 'accession': 'IGVFDO5812FFJI', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.090076+00:00', 'creation_timestamp': '2025-02-20T20:43:44.640267+00:00', '@id': '/human-donors/IGVFDO5812FFJI/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': '7ed83925-78f6-4d08-a5df-d608bb77cd65', 'summary': '7ed83925-78f6-4d08-a5df-d608bb77cd65'}, '/human-donors/IGVFDO8630TWDU/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H371 57_to_72'], 'virtual': False, 'accession': 'IGVFDO8630TWDU', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.302146+00:00', 'creation_timestamp': '2025-02-20T20:43:42.607819+00:00', '@id': '/human-donors/IGVFDO8630TWDU/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': '70f9880a-32f8-46e9-820f-bd6cb94449af', 'summary': '70f9880a-32f8-46e9-820f-bd6cb94449af'}, '/human-donors/IGVFDO3401QPKA/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H456 17_to_32'], 'virtual': False, 'accession': 'IGVFDO3401QPKA', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.234130+00:00', 'creation_timestamp': '2025-02-20T20:43:39.278475+00:00', '@id': '/human-donors/IGVFDO3401QPKA/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': 'c003cd7f-07c7-4db4-8a46-f0c26e40aabc', 'summary': 'c003cd7f-07c7-4db4-8a46-f0c26e40aabc'}, '/human-donors/IGVFDO7463WRZR/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H511 49_to_56'], 'virtual': False, 'accession': 'IGVFDO7463WRZR', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.267254+00:00', 'creation_timestamp': '2025-02-20T20:43:41.323808+00:00', '@id': '/human-donors/IGVFDO7463WRZR/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': 'be2b2aa3-4fd4-44cd-8109-6fc48ee2790a', 'summary': 'be2b2aa3-4fd4-44cd-8109-6fc48ee2790a'}, '/human-donors/IGVFDO1048RJRX/': {'lab': '/labs/jason-buenrostro/', 'sex': 'unspecified', 'taxa': 'Homo sapiens', 'award': '/awards/HG011986/', 'status': 'released', 'aliases': ['buenrostro-bernstein:surya-H443 1_to_16'], 'virtual': False, 'accession': 'IGVFDO1048RJRX', 'submitted_by': '/users/c0838247-5022-46cf-a8fa-426e73bf4c94/', 'schema_version': '14', 'release_timestamp': '2025-03-26T17:33:43.127530+00:00', 'creation_timestamp': '2025-02-20T20:43:36.803877+00:00', '@id': '/human-donors/IGVFDO1048RJRX/', '@type': ['HumanDonor', 'Donor', 'Item'], 'uuid': 'f3c9ab86-5476-49ae-ac00-7b3a63438755', 'summary': 'f3c9ab86-5476-49ae-ac00-7b3a63438755'}}}}


def test_metadata_make_data_tables():
    from metadata import make_data_tables
    expected = {'files': 'file_id\tfile_path\tigvf_portal_url\ttype\tsummary\tassay_titles\tcontent_type\tfile_name\tfile_format\tfile_format_type\tfile_size\tfile_md5sum\tfile_set\tseqspecs\tworkflow\tderived_from\treference_assembly\tcell_type_annotation\tflowcell_id\tillumina_read_type\tlane\tmean_read_length\tsequencing_kit\tsequencing_platform\tsequencing_run\ttranscriptome_annotation\nIGVFFI6594MPVX\tgs://some_destination_bucket/2025/03/18/775b9e95-6c30-4f1f-b772-428745bb0c53/IGVFFI6594MPVX.yaml.gz\thttps://data.igvf.org/configuration-files/IGVFFI6594MPVX/\tConfigurationFile\tseqspec of IGVFFI9831SEGU, IGVFFI8905WBYU, IGVFFI2440LTBO\t["SHARE-seq"]\tseqspec\tIGVFFI6594MPVX.yaml.gz\tyaml\t\t1242\t8336c45ce32429d0f31dd3b9413c0de4\tIGVFDS2534CJYA\t\t\t\t\t\t\t\t\t\t\t\t\t\nIGVFFI7971ZCIE\tgs://some_destination_bucket/2025/03/18/9ca8a328-ee28-4b84-a299-12a91a14e0d2/IGVFFI7971ZCIE.yaml.gz\thttps://data.igvf.org/configuration-files/IGVFFI7971ZCIE/\tConfigurationFile\tseqspec of IGVFFI9846ECMS, IGVFFI1915BHZZ, IGVFFI1517VBJH\t["SHARE-seq"]\tseqspec\tIGVFFI7971ZCIE.yaml.gz\tyaml\t\t1216\t62545fbf3d2c85d50cad140bb8c87e2e\tIGVFDS2259DWKL\t\t\t\t\t\t\t\t\t\t\t\t\t\nIGVFFI8142SBEI\tgs://some_destination_bucket/2025/03/06/3a7b359e-39f7-4240-a6ee-703e6299455b/IGVFFI8142SBEI.h5ad\thttps://data.igvf.org/matrix-files/IGVFFI8142SBEI/\tMatrixFile\tunfiltered cell by gene in sparse gene count matrix\t["SHARE-seq"]\tsparse gene count matrix\tIGVFFI8142SBEI.h5ad\th5ad\t\t63881699\t6672db7b863aa8283fc35420d591eef5\tIGVFDS0718WXPI\t\t/workflows/IGVFWF0507XZOR/\t["IGVFFI9831SEGU", "IGVFFI8905WBYU"]\t\t\t\t\t\t\t\t\t\t\nIGVFFI1517VBJH\tgs://some_destination_bucket/2025/03/14/94b93923-9a1d-441a-af9c-3cc4fec3f153/IGVFFI1517VBJH.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI1517VBJH/\tSequenceFile\tI1 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI1517VBJH.fastq.gz\tfastq\t\t5206068496\t46da9565e75c16a169d881d83901e756\tIGVFDS2259DWKL\t["IGVFFI7971ZCIE"]\t\t\t\t\t\tI1\t\t32.0\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI1915BHZZ\tgs://some_destination_bucket/2025/02/20/603c456d-23ca-4e4c-9db9-b01a33929f3a/IGVFFI1915BHZZ.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI1915BHZZ/\tSequenceFile\tR2 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI1915BHZZ.fastq.gz\tfastq\t\t10279868253\tf4981ce2ce23080f52427a1aaad3c145\tIGVFDS2259DWKL\t["IGVFFI7971ZCIE"]\t\t\t\t\t\tR2\t\t49.06\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI2440LTBO\tgs://some_destination_bucket/2025/03/14/bda1245f-0708-46dc-83b0-519913e90e47/IGVFFI2440LTBO.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI2440LTBO/\tSequenceFile\tI1 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI2440LTBO.fastq.gz\tfastq\t\t6719075164\tad6d9107e67228b2037da34dbacd634a\tIGVFDS2534CJYA\t["IGVFFI6594MPVX"]\t\t\t\t\t\tI1\t\t32.0\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI8905WBYU\tgs://some_destination_bucket/2025/02/20/dff839b9-e8c3-4fd5-adc8-eabf2873b34c/IGVFFI8905WBYU.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI8905WBYU/\tSequenceFile\tR2 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI8905WBYU.fastq.gz\tfastq\t\t10730781494\te1969d8435c7e1b059ab3e5df6944032\tIGVFDS2534CJYA\t["IGVFFI6594MPVX"]\t\t\t\t\t\tR2\t\t50.0\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI9831SEGU\tgs://some_destination_bucket/2025/02/20/ac23fc63-362d-4539-8477-486980ffec9e/IGVFFI9831SEGU.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI9831SEGU/\tSequenceFile\tR1 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI9831SEGU.fastq.gz\tfastq\t\t10787849140\t480e0e47270cdf96cb856fa0d8643762\tIGVFDS2534CJYA\t["IGVFFI6594MPVX"]\t\t\t\t\t\tR1\t\t50.0\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI9846ECMS\tgs://some_destination_bucket/2025/02/20/084c1c10-cf73-446f-940d-62c05a611b8b/IGVFFI9846ECMS.fastq.gz\thttps://data.igvf.org/sequence-files/IGVFFI9846ECMS/\tSequenceFile\tR1 reads from sequencing run 1\t["SHARE-seq"]\treads\tIGVFFI9846ECMS.fastq.gz\tfastq\t\t9872707806\t20791df01e1ea5aaa15ac135aa01eb9e\tIGVFDS2259DWKL\t["IGVFFI7971ZCIE"]\t\t\t\t\t\tR1\t\t49.06\tNovaSeq 6000 S4 Reagent Kit v1.5\t/platform-terms/EFO_0008637/\t1\t\nIGVFFI9764GKVR\tgs://some_destination_bucket/2025/03/06/cc1d12c6-4a61-401c-bbb8-21314b1d6cd0/IGVFFI9764GKVR.tsv.gz\thttps://data.igvf.org/tabular-files/IGVFFI9764GKVR/\tTabularFile\tfragments\t["SHARE-seq"]\tfragments\tIGVFFI9764GKVR.tsv.gz\ttsv\t\t1206512769\t17dcfe73b68c88c636982c553da9b3ea\tIGVFDS0718WXPI\t\t/workflows/IGVFWF0507XZOR/\t["IGVFFI9846ECMS", "IGVFFI1915BHZZ"]\t\t\t\t\t\t\t\t\t\t', 'file_sets': 'file_set_id\tigvf_portal_url\ttype\tassay_term\tassay_titles\tfiles\tassociated_phenotypes\tauxiliary_sets\taverage_guide_coverage\taverage_insert_size\taward\tbarcode_map\tconstruct_library_sets\tcontrol_file_sets\texon\tfile_set_type\tguide_type\tinput_file_sets\tlab\tpreferred_assay_title\tsample_summary\tsamples\tscope\tselection_criteria\tsequencing_library_types\tsmall_scale_gene_list\tsmall_scale_loci_list\tsummary\ttargeted_genes\nIGVFDS0718WXPI\thttps://data.igvf.org/analysis-sets/IGVFDS0718WXPI/\tAnalysisSet\t\t["SHARE-seq"]\t["IGVFFI8142SBEI", "IGVFFI9764GKVR"]\t\t\t\t\t/awards/HG011986/\t\t\t\t\tintermediate analysis\t\t["IGVFDS2259DWKL", "IGVFDS2534CJYA"]\t/labs/jason-buenrostro/\t\tHomo sapiens colon epithelial cell organoid induced to colon, at 7 day(s) post change\t["IGVFSM7625PGWV"]\t\t\t\t\t\tsingle-cell ATAC-seq (SHARE-seq), single-cell RNA sequencing assay (SHARE-seq)\t\nIGVFDS2259DWKL\thttps://data.igvf.org/measurement-sets/IGVFDS2259DWKL/\tMeasurementSet\t/assay-terms/OBI_0002764/\t\t["IGVFFI7971ZCIE", "IGVFFI9846ECMS", "IGVFFI1915BHZZ", "IGVFFI1517VBJH"]\t\t\t\t\t/awards/HG011986/\t\t\t\t\texperimental data\t\t\t/labs/jason-buenrostro/\tSHARE-seq\t\t["IGVFSM7625PGWV"]\t\t\t\t\t\tsingle-cell ATAC-seq (SHARE-seq)\t\nIGVFDS2534CJYA\thttps://data.igvf.org/measurement-sets/IGVFDS2534CJYA/\tMeasurementSet\t/assay-terms/OBI_0002631/\t\t["IGVFFI6594MPVX", "IGVFFI9831SEGU", "IGVFFI8905WBYU", "IGVFFI2440LTBO"]\t\t\t\t\t/awards/HG011986/\t\t\t\t\texperimental data\t\t\t/labs/jason-buenrostro/\tSHARE-seq\t\t["IGVFSM7625PGWV"]\t\t\t\t\t\tsingle-cell RNA sequencing assay (SHARE-seq)\t', 'samples': 'sample_id\tigvf_portal_url\ttype\tsummary\tsample_terms\tmodifications\ttargeted_sample_term\tbiosample_type\tmultiplexed_samples\tpooled_from\tdonors\tconstruct_library_sets\tbiosample_qualifiers\tembryonic\tsorted_fractions\tdonor_age_at_collection_unit_upper_bound\tdonor_age_at_collection_unit_lower_bound\tdonor_age_at_collection_unit\tmoi\nIGVFSM7625PGWV\thttps://data.igvf.org/in-vitro-systems/IGVFSM7625PGWV/\tInVitroSystem\tHomo sapiens colon epithelial cell organoid induced to colon for 7 days\t["/sample-terms/CL_0011108/"]\t\t/sample-terms/UBERON_0001155/\t["organoid"]\t\t\t["IGVFDO1048RJRX", "IGVFDO3401QPKA", "IGVFDO7463WRZR", "IGVFDO8630TWDU", "IGVFDO5812FFJI", "IGVFDO9637UZMV"]\t\t\tFalse\t[]\t\t\t\t', 'donors': 'donor_id\tigvf_portal_url\ttype\treported_ethnicity\tphenotypic_features\tphenotypic_sex\torganism_type\nIGVFDO1048RJRX\thttps://data.igvf.org/human-donors/IGVFDO1048RJRX/\tHumanDonor\t\t\tunspecified\tHomo sapiens\nIGVFDO3401QPKA\thttps://data.igvf.org/human-donors/IGVFDO3401QPKA/\tHumanDonor\t\t\tunspecified\tHomo sapiens\nIGVFDO5812FFJI\thttps://data.igvf.org/human-donors/IGVFDO5812FFJI/\tHumanDonor\t\t\tunspecified\tHomo sapiens\nIGVFDO7463WRZR\thttps://data.igvf.org/human-donors/IGVFDO7463WRZR/\tHumanDonor\t\t\tunspecified\tHomo sapiens\nIGVFDO8630TWDU\thttps://data.igvf.org/human-donors/IGVFDO8630TWDU/\tHumanDonor\t\t\tunspecified\tHomo sapiens\nIGVFDO9637UZMV\thttps://data.igvf.org/human-donors/IGVFDO9637UZMV/\tHumanDonor\t\t\tunspecified\tHomo sapiens'}
    actual = make_data_tables(METADATA, 'some_destination_bucket', 'https://data.igvf.org')
    for k, v in actual.items():
        _item = {k: v}
        assert expected[k] == v, f'Actual: {_item}'
    assert expected == actual, f'{actual}'
